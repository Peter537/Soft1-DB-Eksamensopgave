# Databaser

## SQL

https://dbdiagram.io/d

```dbml
Table users {
  id integer [primary key]
  email varchar [unique]
  name varchar
  password varchar [note: "hashed password"]
  created_at timestamp
}

Table user_reviews {
  id integer [primary key]
  reviewer integer
  reviewed integer
  rating decimal
  description varchar
  created_at timestamp
}

Ref: users.id < user_reviews.reviewed
Ref: users.id < user_reviews.reviewer
```

## Redis

**Ofte brugte søgninger?**

Not really sure om det her ville give mening.

**Mest sete postings**

Vi har en liste med ZSET i Redis `views:current_hour`, og bruger `ZINCRBY views:current_hour 1 {postingId}` for at opdatere den.

Hver gang klokken bliver X:00, så har vi et cron job / scheduled task der kører `ZREVRANGE views:current_hour 0 10 WITHSCORES` og gemmer de 10 mest sete postings i en liste `views:top_10` i Redis.

**Indkøbskurv**

Første gang en bruger logger ind på siden opretter vi en slags `Set-Cookie: sessionId=<UUID>; Secure; HttpOnly; SameSite=Lax; Max-Age=86400` som gemmes på siden og sendes med i alle requests.

Vi laver så en `cart:{sessionId}` i Redis som indeholder en liste over alle varer (postings._id fra Mongo) i kurven:

```json
{
  "sessionId": "", // Required, from cookie
  "createdAt": "", // Auto generated by Redis
  "items": [
    {
      "postingId": "", // Required, from MongoDB postings._id
      "quantity": , // Required, default 1
    },
  ]
}
```

## MongoDB

Vi laver en `postings` document i MongoDB, som indeholder alle salgsopslag.

```json
{
    "_id": ObjectId("..."), // Auto generated by MongoDB
    "user_id": Integer, // Required, from SQL users table
    "title": String, // Required
    "price": Number, // Required
    "description": String, // Optional
    "category": String, // Required
    "item_count": Integer, // Required, 1 as default
    "location_city": String, // Optional
    "location_country": String, // Required
    "specifications": [ // Optional
        {
            "key": String, // Required
            "value": String // Required
        }
    ]
}
```

# TBD

1. Skal payment_log være i SQL eller MongoDB?

ex.

```dbml
Table payment_log {
  id integer [primary key]
  user_id integer [note: "Could be null"]
  total_amount decimal
}

Table payment_log_items {
  id integer [primary key]
  payment_log_id integer
  item_name integer
  item_quantity integer
  item_price decimal
  seller varchar
}
```

Vi laver en `payment_log` document i MongoDB, som indeholder en log over alle betalinger.

```json
{
    "_id": ObjectId("..."), // Auto generated by MongoDB
    "user_id": Integer, // Required, from SQL users table
    "total_amount": Number, // Required
    "created_at": Date // Auto generated by MongoDB
    "items": [ // Optional
        {
            .. stuff about the item
            "quantity": Integer // Required
        }
    ]
}
```
